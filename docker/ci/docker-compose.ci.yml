services:
  app:
    image: ${IMAGE}:${TAG}            # ← use the image built in the build job
    env_file:
      - .env.ci
    depends_on:
      mysql:
        condition: service_healthy
    networks: [ci_net]
    # no ports needed in CI

  mysql:
    image: mysql:8.4
    command:
      - --default-authentication-plugin=mysql_native_password
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --skip-log-bin
      - --innodb-buffer-pool-size=128M     # ↓ conservative to avoid OOM/crash
      - --max-connections=50
      - --performance-schema=OFF
    environment:
      MYSQL_ROOT_PASSWORD: secret
      MYSQL_DATABASE: testing
      MYSQL_USER: ci_user
      MYSQL_PASSWORD: ci_pass
    healthcheck:
      # Use root for reliability during init; user accounts may not exist yet
      test: ["CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "-uroot", "-psecret"]
      interval: 3s
      timeout: 3s
      retries: 40
      start_period: 5s
    # Prefer a named volume over tmpfs on GH runners (tmpfs can fail unpredictably)
    volumes:
      - mysql_data:/var/lib/mysql
    networks: [ci_net]

networks:
  ci_net: {}

volumes:
  mysql_data: {}
